// PMP Study Application Database Schema
// Prisma schema for PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USER & AUTHENTICATION ====================

model User {
  id                  String    @id @default(uuid())
  email               String    @unique @db.VarChar(255)
  passwordHash        String
  name                String @db.VarChar(255)
  emailVerified       Boolean   @default(false)
  emailVerifyToken    String?
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  subscription       UserSubscription?
  ebookProgress      UserEbookProgress?
  studyProgress      StudyProgress[]
  flashcardReviews   FlashcardReview[]
  questionAttempts   QuestionAttempt[]
  studyActivities    StudyActivity[]
  customFlashcards   Flashcard[]
  refreshTokens      RefreshToken[]
  passwordResets     PasswordReset[]
  teamMemberships    TeamMember[]
  ownedTeams         Team[]              @relation("TeamAdmin")

  // Privacy & Compliance
  privacyConsent          PrivacyConsent?
  dataExportRequests      DataExportRequest[]
  accountDeletionRequests AccountDeletionRequest[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model PasswordReset {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_resets")
}

// ==================== SUBSCRIPTION & BILLING ====================

model SubscriptionTier {
  id            String @id @default(uuid())
  name          String @unique // 'free', 'pro', 'corporate'
  displayName   String
  price         Float
  billingPeriod String // 'monthly', 'annual'
  features      Json   // TierFeatures object
  isActive      Boolean @default(true)
  createdAt     DateTime @default(now())

  subscriptions UserSubscription[]

  @@map("subscription_tiers")
}

model UserSubscription {
  id                   String   @id @default(uuid())
  userId               String   @unique
  tierId               String
  status               String   // 'active', 'cancelled', 'expired', 'grace_period'
  startDate            DateTime @default(now())
  endDate              DateTime
  paypalSubscriptionId String?
  stripeCustomerId     String?
  stripeSubscriptionId String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  tier SubscriptionTier @relation(fields: [tierId], references: [id])

  @@index([userId, status])
  @@map("user_subscriptions")
}

model PaymentTransaction {
  id                    String   @id @default(uuid())
  userId                String
  paypalOrderId         String?  @unique
  paypalPayerId         String?
  stripeSessionId       String?  @unique
  stripePaymentIntentId String?  @unique
  amount                Float
  currency              String   @default("USD")
  status                String   // 'pending', 'completed', 'failed', 'refunded'
  tierId                String
  billingPeriod         String
  metadata              Json?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("payment_transactions")
}

// ==================== CONTENT: DOMAINS & TASKS ====================

model Domain {
  id               String @id @default(uuid())
  name             String
  code             String @unique // 'PEOPLE', 'PROCESS', 'BUSINESS'
  description      String
  weightPercentage Int
  orderIndex       Int

  tasks       Task[]
  flashcards  Flashcard[]
  questions   PracticeQuestion[]

  @@map("domains")
}

model Task {
  id          String   @id @default(uuid())
  domainId    String
  code        String   @unique // '1.1', '2.3', etc.
  name        String
  description String
  enablers    Json     // String array of enablers
  orderIndex  Int

  domain      Domain       @relation(fields: [domainId], references: [id])
  studyGuide  StudyGuide?
  flashcards  Flashcard[]
  questions   PracticeQuestion[]

  @@map("tasks")
}

// ==================== STUDY GUIDES ====================

model StudyGuide {
  id        String   @id @default(uuid())
  taskId    String   @unique
  title     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  task     Task           @relation(fields: [taskId], references: [id])
  sections StudySection[]

  @@map("study_guides")
}

model StudySection {
  id           String @id @default(uuid())
  studyGuideId String
  title        String
  content      String @db.Text // Markdown content
  orderIndex   Int

  studyGuide StudyGuide      @relation(fields: [studyGuideId], references: [id], onDelete: Cascade)
  progress   StudyProgress[]

  @@map("study_sections")
}

model StudyProgress {
  id          String    @id @default(uuid())
  userId      String
  sectionId   String
  completed   Boolean   @default(false)
  completedAt DateTime?

  user    User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  section StudySection @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@unique([userId, sectionId])
  @@map("study_progress")
}

// ==================== FLASHCARDS ====================

model Flashcard {
  id        String   @id @default(uuid())
  domainId  String
  taskId    String
  front     String   // Question or term
  back      String   // Answer or definition
  isCustom  Boolean  @default(false)
  createdBy String?  // User ID if custom
  createdAt DateTime @default(now())

  domain   Domain   @relation(fields: [domainId], references: [id])
  task     Task     @relation(fields: [taskId], references: [id])
  creator  User?    @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  reviews  FlashcardReview[]
  sessions FlashcardSessionCard[]

  @@map("flashcards")
}

model FlashcardReview {
  id             String   @id @default(uuid())
  userId         String
  cardId         String
  easeFactor     Float    @default(2.5) // SM-2 algorithm
  interval       Int      @default(1)   // Days until next review
  repetitions    Int      @default(0)   // Successful repetitions
  nextReviewDate DateTime
  lastReviewDate DateTime @default(now())

  user User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  card Flashcard @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@unique([userId, cardId])
  @@index([userId, nextReviewDate])
  @@index([cardId])
  @@map("flashcard_reviews")
}

model FlashcardSession {
  id          String    @id @default(uuid())
  userId      String
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  totalCards  Int       @default(0)
  knowIt      Int       @default(0)
  learning    Int       @default(0)
  dontKnow    Int       @default(0)
  totalTimeMs Int       @default(0)

  cards FlashcardSessionCard[]

  @@map("flashcard_sessions")
}

model FlashcardSessionCard {
  id          String   @id @default(uuid())
  sessionId   String
  cardId      String
  rating      String?  // 'know_it', 'learning', 'dont_know'
  timeSpentMs Int?
  answeredAt  DateTime?

  session FlashcardSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  card    Flashcard        @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@map("flashcard_session_cards")
}

// ==================== PRACTICE QUESTIONS ====================

model PracticeQuestion {
  id           String   @id @default(uuid())
  domainId     String
  taskId       String
  questionText String
  explanation  String
  difficulty   String   // 'easy', 'medium', 'hard'
  methodology  String?  // 'predictive', 'agile', 'hybrid'
  tags         String[] // Array of tags for filtering
  externalId   String?  @unique // To map back to JSON ID (e.g., 'business-task1-q1')
  createdAt    DateTime @default(now())

  domain   Domain           @relation(fields: [domainId], references: [id])
  task     Task             @relation(fields: [taskId], references: [id])
  options  QuestionOption[]
  attempts QuestionAttempt[]
  sessions PracticeSessionQuestion[]
  formulas QuestionFormula[]

  @@map("practice_questions")
}

model QuestionOption {
  id         String  @id @default(uuid())
  questionId String
  text       String
  isCorrect  Boolean

  question PracticeQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("question_options")
}

model QuestionAttempt {
  id               String   @id @default(uuid())
  userId           String
  questionId       String
  sessionId        String?
  selectedOptionId String
  isCorrect        Boolean
  timeSpentMs      Int
  flagged          Boolean  @default(false)
  attemptedAt      DateTime @default(now())

  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  question PracticeQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("question_attempts")
}

model PracticeSession {
  id             String    @id @default(uuid())
  userId         String
  startedAt      DateTime  @default(now())
  completedAt    DateTime?
  totalQuestions Int       @default(0)
  correctAnswers Int       @default(0)
  totalTimeMs    Int       @default(0)
  isMockExam     Boolean   @default(false)
  timeLimit      Int?      // Milliseconds (230 minutes for mock exam)

  questions PracticeSessionQuestion[]

  @@map("practice_sessions")
}

model PracticeSessionQuestion {
  id               String    @id @default(uuid())
  sessionId        String
  questionId       String
  orderIndex       Int       // Position of question in session for consistent pagination
  selectedOptionId String?
  isCorrect        Boolean?
  timeSpentMs      Int?
  answeredAt       DateTime?

  session  PracticeSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  question PracticeQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([sessionId, orderIndex])
  @@index([sessionId, questionId])
  @@index([sessionId])
  @@map("practice_session_questions")
}

// ==================== FORMULAS ====================

model Formula {
  id          String   @id @default(uuid())
  name        String
  category    String   // 'earned_value', 'scheduling', 'cost', etc.
  expression  String   // 'CPI = EV / AC'
  description String
  whenToUse   String
  example     Json     // FormulaExample object
  createdAt   DateTime @default(now())

  variables FormulaVariable[]
  questions QuestionFormula[]

  @@map("formulas")
}

model FormulaVariable {
  id          String  @id @default(uuid())
  formulaId   String
  symbol      String
  name        String
  description String
  unit        String?

  formula Formula @relation(fields: [formulaId], references: [id], onDelete: Cascade)

  @@map("formula_variables")
}

model QuestionFormula {
  questionId String
  formulaId  String

  question PracticeQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  formula  Formula          @relation(fields: [formulaId], references: [id], onDelete: Cascade)

  @@id([questionId, formulaId])
  @@map("question_formulas")
}

// ==================== ANALYTICS & ACTIVITY ====================

model StudyActivity {
  id           String   @id @default(uuid())
  userId       String
  activityType String   // 'study_guide_view', 'flashcard_session', etc.
  targetId     String
  durationMs   Int      @default(0)
  metadata     Json?
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, activityType, createdAt])
  @@index([activityType, createdAt])
  @@index([userId, createdAt])
  @@map("study_activities")
}

// ==================== TEAM MANAGEMENT (Corporate) ====================

model Team {
  id           String   @id @default(uuid())
  name         String
  adminId      String
  licenseCount Int
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  admin       User         @relation("TeamAdmin", fields: [adminId], references: [id])
  members     TeamMember[]
  invitations TeamInvitation[]
  goals       TeamGoal[]
  alerts      TeamAlert[]

  @@map("teams")
}

model TeamMember {
  id       String   @id @default(uuid())
  teamId   String
  userId   String
  role     String   // 'admin', 'member'
  joinedAt DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@map("team_members")
}

model TeamInvitation {
  id         String    @id @default(uuid())
  teamId     String
  email      String
  token      String    @unique
  expiresAt  DateTime
  acceptedAt DateTime?
  createdAt  DateTime  @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@map("team_invitations")
}

model TeamGoal {
  id        String   @id @default(uuid())
  teamId    String
  type      String   // 'completion', 'accuracy', 'study_time'
  target    Float
  deadline  DateTime
  createdAt DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@map("team_goals")
}

model TeamAlert {
  id           String   @id @default(uuid())
  teamId       String
  memberId     String
  memberName   String
  type         String   // 'behind_schedule', 'inactive', 'struggling'
  message      String
  acknowledged Boolean  @default(false)
  createdAt    DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@map("team_alerts")
}

// ==================== EBOOK ====================

model EbookChapter {
  id          String          @id @default(uuid())
  slug        String          @unique // e.g., "01-introduction"
  title       String          // e.g., "Chapter 1: Fundamentals & Exam Overview"
  description String?         @db.Text
  orderIndex  Int             // 1-11 for chapters, 12 for appendices
  isPremium   Boolean         @default(false) // true for premium chapters
  minTier     String          @default("free") // free, mid-level, high-end, corporate

  sections    EbookSection[]

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([orderIndex])
  @@index([isPremium])
  @@map("ebook_chapters")
}

model EbookSection {
  id          String          @id @default(uuid())
  chapterId   String
  chapter     EbookChapter    @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  slug        String          // e.g., "understanding-exam"
  title       String          // e.g., "1.1 Understanding the New PMP Exam"
  content     String          @db.Text // Markdown content
  orderIndex  Int             // Order within chapter

  // Navigation
  prevSection String?         // Previous section slug
  nextSection String?         // Next section slug

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@unique([chapterId, slug])
  @@index([chapterId, orderIndex])
  @@map("ebook_sections")
}

model UserEbookProgress {
  id                String   @id @default(uuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  lastChapterId     String?
  lastSectionId     String?

  // Array of completed section IDs for tracking progress
  completedSections String[] @default([])

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([userId])
  @@map("user_ebook_progress")
}

// ==================== PRIVACY & COMPLIANCE (GDPR/CCPA) ====================

model PrivacyConsent {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Consent tracking
  cookieConsent      Boolean  @default(false)
  privacyPolicyAccepted Boolean @default(false)
  termsAccepted      Boolean  @default(false)

  // Consent metadata
  consentVersion     String   @default("1.0")
  consentIpAddress   String?
  consentUserAgent   String?  @db.Text
  consentedAt        DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Withdrawal tracking
  withdrawnAt        DateTime?
  withdrawnReason    String?

  @@map("privacy_consent")
}

model DataExportRequest {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  status      String   @default("pending") // 'pending', 'processing', 'completed', 'failed'
  requestId   String   @unique

  // Export metadata
  requestedAt DateTime @default(now())
  completedAt DateTime?
  expiresAt   DateTime @default(dbgenerated("now() + interval '7 days'"))
  downloadUrl String?
  fileSize    Int?     // in bytes

  // Processing details
  errorMessage String?  @db.Text
  processedBy  String?  // admin user ID if manually processed

  @@index([userId, status])
  @@index([status])
  @@index([expiresAt])
  @@map("data_export_requests")
}

model AccountDeletionRequest {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  status      String   @default("pending") // 'pending', 'processing', 'completed', 'cancelled'

  // Deletion timeline
  requestedAt     DateTime @default(now())
  gracePeriodEnds DateTime @default(dbgenerated("now() + interval '30 days'"))
  completedAt     DateTime?
  cancelledAt     DateTime?

  // Deletion details
  deletionReason  String?
  ipAddress       String?
  userAgent       String?  @db.Text

  // Processing details
  softDeletedAt   DateTime?
  hardDeleteScheduledFor DateTime?
  processedBy     String?  // admin user ID

  @@index([userId, status])
  @@index([status])
  @@index([gracePeriodEnds])
  @@map("account_deletion_requests")
}

model PrivacyAuditLog {
  id          String   @id @default(uuid())

  // Action details
  actionType  String   // 'data_export', 'account_deletion', 'consent_given', 'consent_withdrawn', 'data_accessed'
  entityType  String   // 'user', 'consent', 'export_request', 'deletion_request'
  entityId    String

  // User context
  userId      String?
  performedBy String?  // user ID or 'system'

  // Request metadata
  ipAddress   String?
  userAgent   String?  @db.Text
  requestId   String?  // correlation ID

  // Action details
  details     Json?    // additional context
  status      String   @default("success") // 'success', 'failed', 'cancelled'

  createdAt   DateTime @default(now())

  @@index([userId, actionType])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("privacy_audit_logs")
}
