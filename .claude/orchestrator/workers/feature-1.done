# Feature 1: Codebase Patterns Analysis - Complete

## Summary

Created a comprehensive patterns document (`/.claude/agents/patterns.md`) that documents all codebase patterns, conventions, and templates for the PMP Study Application.

## What Was Analyzed

### 1. API Routes Pattern (`packages/api/src/routes/`)
- Express Router pattern with async/await handlers
- Middleware chain: `authMiddleware`, `requireTier`, `requireFeature`, `validateBody`
- Consistent response format: `{ success: true, data: ..., message: ... }`
- Error handling with `next(error)` passing to centralized error handler

### 2. API Services Pattern (`packages/api/src/services/`)
- Service class with singleton export
- Methods: `create`, `getById`, `list`, `update`, `delete`
- Prisma client for database operations
- `AppError` throwing for error cases
- Private `mapToResponse` methods for data sanitization

### 3. Zod Validators Pattern (`packages/api/src/validators/`)
- Schema definitions using `z.object()`
- Separate schemas for create (required fields) vs update (optional fields)
- Export inferred TypeScript types via `z.infer<>`
- Common patterns: email, uuid, min/max, enums, arrays

### 4. Prisma Schema Patterns
- 23+ models covering: auth, subscriptions, content, flashcards, practice questions, formulas, analytics, teams
- Key relationships: User → Subscription, Domain → Task → StudyGuide, Flashcard → FlashcardReview (SM-2)
- Cascade deletes for related data
- Indexes on frequently queried fields

### 5. Frontend Component Pattern
- `'use client'` directive for client components
- `useAuth()` hook for authentication state
- API client functions from `@/lib/api`
- TailwindCSS with custom CSS variables for styling
- Next.js App Router with `app/` directory structure

### 6. API Client Pattern (`packages/web/src/lib/api.ts`)
- Centralized `apiRequest` function
- Auto-includes Bearer token from localStorage
- Typed responses with `ApiResponse<T>`
- Feature-grouped exports: `authApi`, `contentApi`, `flashcardApi`, etc.

### 7. Error Handling Pattern
- `AppError` class with static factory methods
- Error codes from `@pmp/shared` constants
- Centralized error handler with `errorHandler` middleware
- Prisma and Zod error handling built-in

### 8. Testing Pattern
- Test setup in `packages/api/src/test/setup.ts`
- Mocked Prisma client for unit tests
- Jest + supertest for integration tests
- 80% coverage threshold configured

### 9. Shared Types (`packages/shared/src/types/`)
- Auth types: User, RegisterInput, LoginInput, AuthResult, JwtPayload
- Subscription types: TierName, TierFeatures, UserSubscription
- Feature-specific types: flashcard, practice, formula, analytics, team
- Error code constants: AUTH_ERRORS, SUBSCRIPTION_ERRORS, etc.

### 10. Naming Conventions
- Routes: `[feature].routes.ts`
- Services: `[feature].service.ts`
- Validators: `[feature].validator.ts`
- Components: PascalCase with `.tsx` extension
- Functions: `getX`, `createX`, `updateX`, `deleteX`, `handleX`
- Constants: UPPER_CASE or camelCase for objects

## Templates Included

- API route handler (GET, POST, PATCH, DELETE)
- API service class with CRUD operations
- Zod validator schemas
- Frontend component with auth context
- API client function group
- Test setup and service tests
- Prisma query patterns (find, create, update, transaction)
- Error throwing patterns

## Quick Reference Guide

Added a "Quick Reference: Adding a New Feature" section showing the 7-step process:
1. Add Prisma schema
2. Add types to shared
3. Create service
4. Create validator
5. Create routes
6. Add API client
7. Create frontend component

## File Created

`.claude/agents/patterns.md` - 500+ lines of comprehensive patterns documentation

## Status: COMPLETE
