name: Security - Dependency Scanning

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  schedule:
    # Run daily at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  npm-audit:
    name: npm Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --json > npm-audit-report.json || true

      - name: Check for high/critical vulnerabilities
        run: |
          high_critical=$(jq '[.vulnerabilities | to_entries[] | select(.value.severity == "high" or .value.severity == "critical")] | length' npm-audit-report.json)
          if [ "$high_critical" -gt 0 ]; then
            echo "âŒ Found $high_critical high/critical vulnerabilities"
            jq '.vulnerabilities | to_entries[] | select(.value.severity == "high" or .value.severity == "critical") | {name: .key, severity: .value.severity, url: .value.url}' npm-audit-report.json
            echo "::error::High or critical vulnerabilities found in dependencies"
            exit 1
          fi

      - name: Upload npm audit report
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-report
          path: npm-audit-report.json
          retention-days: 30

  snyk:
    name: Snyk Dependency Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --json-file-output=snyk-report.json

      - name: Upload Snyk report to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: snyk-report.json
          category: snyk

      - name: Upload Snyk report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: snyk-report
          path: snyk-report.json
          retention-days: 30

  dependabot-merge:
    name: Auto-merge Dependabot PRs
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    needs: [npm-audit, snyk]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Auto-merge minor/patch updates
        uses: ahmadnassri/action-dependabot-auto-merge@v2
        with:
          target: minor
          github-token: ${{ secrets.GITHUB_TOKEN }}

  license-compliance:
    name: License Compliance Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      - name: Generate license report
        run: |
          npx license-report --output=json > license-report.json || true

      - name: Check for problematic licenses
        run: |
          # Check for GPL, AGPL, or other restrictive licenses
          if [ -f license-report.json ]; then
            problematic=$(jq '[.[] | select(.license | test("GPL|AGPL|SSPL"))] | length' license-report.json)
            if [ "$problematic" -gt 0 ]; then
              echo "âš ï¸ Found $problematic packages with restrictive licenses"
              jq '[.[] | select(.license | test("GPL|AGPL|SSPL"))] | {name, license, publisher}' license-report.json
              echo "::warning::Review license compliance for flagged packages"
            fi
          fi

      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: license-report.json
          retention-days: 30

  dependency-summary:
    name: Dependency Security Summary
    runs-on: ubuntu-latest
    needs: [npm-audit, snyk, license-compliance]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Generate dependency summary
        run: |
          echo "# ðŸ“¦ Dependency Security Summary" > $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… npm Audit: Completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Snyk: Completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… License Compliance: Completed" >> $GITHUB_STEP_SUMMARY
