name: API Documentation Validation

on:
  pull_request:
    paths:
      - 'packages/api/src/routes/**'
      - 'packages/api/src/utils/openapi/**'
      - 'packages/api/src/middleware/swagger.middleware.ts'
      - 'packages/api/src/config/openapi.ts'
  push:
    branches: [main]
    paths:
      - 'packages/api/src/routes/**'
      - 'packages/api/src/utils/openapi/**'
      - 'packages/api/src/middleware/swagger.middleware.ts'
      - 'packages/api/src/config/openapi.ts'

jobs:
  validate-openapi-spec:
    name: Validate OpenAPI Specification
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'packages/api/package-lock.json'

      - name: Install dependencies
        run: |
          cd packages/api
          npm ci

      - name: Build TypeScript
        run: |
          cd packages/api
          npm run build

      - name: Export OpenAPI specification
        run: |
          cd packages/api
          npm run export:openapi

      - name: Check if spec is up to date
        run: |
          cd packages/api
          if git diff --exit-code openapi/openapi.json; then
            echo "âœ… OpenAPI spec is up to date"
          else
            echo "âŒ OpenAPI spec is out of date"
            echo "Please run 'npm run docs:export' to update the specification"
            git diff openapi/openapi.json
            exit 1
          fi

      - name: Validate OpenAPI syntax
        run: |
          cd packages/api
          npx -p @apidevtools/swagger-cli swagger-cli validate openapi/openapi.json

      - name: Upload OpenAPI spec artifact
        uses: actions/upload-artifact@v3
        with:
          name: openapi-spec
          path: packages/api/openapi/openapi.json
          retention-days: 30

  generate-postman-collection:
    name: Generate Postman Collection
    runs-on: ubuntu-latest
    needs: validate-openapi-spec

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'packages/api/package-lock.json'

      - name: Install dependencies
        run: |
          cd packages/api
          npm ci

      - name: Generate Postman collection
        run: |
          cd packages/api
          npm run generate:postman

      - name: Upload Postman collection artifact
        uses: actions/upload-artifact@v3
        with:
          name: postman-collection
          path: packages/api/openapi/postman-collection.json
          retention-days: 30

  check-documentation-coverage:
    name: Check Documentation Coverage
    runs-on: ubuntu-latest
    needs: validate-openapi-spec

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check route coverage
        run: |
          # Count total routes in codebase
          TOTAL_ROUTES=$(find packages/api/src/routes -name '*.ts' ! -name '*.test.ts' | wc -l | tr -d ' ')

          # Count documented routes in OpenAPI spec
          cd packages/api
          npm run export:openapi
          DOCUMENTED_PATHS=$(node -e "
            const spec = require('./openapi/openapi.json');
            console.log(Object.keys(spec.paths).length);
          ")

          echo "Total route files: $TOTAL_ROUTES"
          echo "Documented endpoints: $DOCUMENTED_PATHS"

          # Require at least 80% documentation coverage
          COVERAGE_THRESHOLD=80
          if [ "$DOCUMENTED_PATHS" -lt "$TOTAL_ROUTES" ]; then
            echo "âš ï¸ Some routes may not be documented"
            echo "Please ensure all API endpoints are documented in OpenAPI spec"
          fi

  notify-documentation-update:
    name: Notify Documentation Update
    runs-on: ubuntu-latest
    needs: [validate-openapi-spec, generate-postman-collection]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Create summary comment
        run: |
          echo "## ðŸ“š API Documentation Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The OpenAPI specification has been validated and updated:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… OpenAPI spec validated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Postman collection generated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Documentation coverage checked" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Access Documentation" >> $GITHUB_STEP_SUMMARY
          echo "- **Swagger UI**: \`http://localhost:4000/api-docs\` (dev)" >> $GITHUB_STEP_SUMMARY
          echo "- **OpenAPI Spec**: \`./packages/api/openapi/openapi.json\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Postman Collection**: \`./packages/api/openapi/postman-collection.json\`" >> $GITHUB_STEP_SUMMARY
