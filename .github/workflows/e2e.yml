name: E2E Tests

on:
  push:
    branches: [master, main, develop]
  pull_request:
    branches: [master, main, develop]
  schedule:
    # Run E2E tests daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  playwright_version: 'latest'

jobs:
  e2e-tests:
    name: E2E Tests (${{ matrix.browser }})
    runs-on: ubuntu-latest
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
        shard: [1/4, 2/4, 3/4, 4/4]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          npx playwright install --with-deps ${{ matrix.browser }}

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Start services
        run: |
          # Start database and API using Docker Compose
          docker-compose up -d postgres

          # Wait for services to be ready
          npm run wait:services

      - name: Setup database
        run: |
          # Run migrations
          npm run db:migrate

          # Seed test data
          npm run db:seed

      - name: Build application
        run: |
          npm run build:shared
          npm run build:api
          npm run build:web

      - name: Start API server
        run: |
          npm run dev:api &
          echo $! > api.pid
          # Wait for API to be ready
          npx wait-on http://localhost:3001 -t 60000

      - name: Run E2E tests
        env:
          CI: true
          BASE_URL: http://localhost:3005
          API_URL: http://localhost:3001
          PLAYWRIGHT_SHARD: ${{ matrix.shard }}
        run: |
          cd packages/web
          npx playwright test \
            --project=${{ matrix.browser }} \
            --shard=${{ matrix.shard }} \
            --reporter=json \
            --reporter=html \
            --output-dir=test-results/${{ matrix.browser }}-shard-${{ matrix.shard }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.browser }}-shard-${{ matrix.shard }}
          path: packages/web/test-results/
          retention-days: 30

      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ matrix.browser }}-shard-${{ matrix.shard }}
          path: packages/web/test-results/screenshots/
          retention-days: 7

      - name: Upload traces on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: traces-${{ matrix.browser }}-shard-${{ matrix.shard }}
          path: packages/web/test-results/traces/
          retention-days: 7

      - name: Upload videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: videos-${{ matrix.browser }}-shard-${{ matrix.shard }}
          path: packages/web/test-results/videos/
          retention-days: 7

      - name: Stop services
        if: always()
        run: |
          if [ -f api.pid ]; then
            kill $(cat api.pid) || true
          fi
          docker-compose down -v

  visual-regression:
    name: Visual Regression Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install --with-deps chromium

      - name: Build application
        run: |
          npm run build:shared
          npm run build:api
          npm run build:web

      - name: Run visual regression tests
        env:
          CI: true
        run: |
          cd packages/web
          npx playwright test --project=visual-regression

      - name: Upload visual diff results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-regression-report
          path: packages/web/playwright-report/
          retention-days: 30

  e2e-report:
    name: Generate E2E Report
    runs-on: ubuntu-latest
    needs: [e2e-tests]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results/

      - name: Merge test reports
        run: |
          npm install -g playwright-reporter-merge
          playwright-reporter-merge test-results/*/results.json -o merged-results.json

      - name: Generate HTML report
        run: |
          npx playwright show-report
        continue-on-error: true

      - name: Upload merged report
        uses: actions/upload-artifact@v4
        with:
          name: merged-e2e-report
          path: merged-results.json
          retention-days: 90

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('merged-results.json', 'utf8'));

            const total = results.stats.expected;
            const passed = results.stats.expected;
            const failed = results.stats.unexpected;
            const skipped = results.stats.skipped;

            const comment = `## üé≠ E2E Test Results

            **Total Tests:** ${total}
            ‚úÖ **Passed:** ${passed}
            ‚ùå **Failed:** ${failed}
            ‚è≠Ô∏è **Skipped:** ${skipped}

            ${failed > 0 ? '‚ùå Some tests failed. Check the artifacts for details.' : '‚úÖ All tests passed!'}

            [View full report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [e2e-tests, visual-regression]
    if: failure()

    steps:
      - name: Send notification
        run: |
          echo "E2E tests failed. Check the workflow logs for details."
          # Add Slack/Discord/email notification here
